services:
  api:
    build:
      context: ./back
      dockerfile: Dockerfile.dev
    ports:
      - "${API_PORT}:3000"
    environment:
      - CHOKIDAR_USEPOLLING=true
      - ALLOWED_URL=http://${APP_HOST},http://localhost:${APP_PORT}
      - APP_URL=http://localhost:${APP_PORT}
      - API_URL=http://localhost:${API_PORT}
      - PLAYWRIGHT_WS_ENDPOINT=${PLAYWRIGHT_WS_ENDPOINT:-ws://playwright-debug:3000}
      - PLAYWRIGHT_DEBUG=${PLAYWRIGHT_DEBUG:-true}
      - PLAYWRIGHT_SLOW_MO=${PLAYWRIGHT_SLOW_MO}
      # Session / JWT Settings (defaults in Joi schema: ACCESS=15m, REFRESH=7d, MAX_SESSIONS=0=unlimited)
      # - JWT_ACCESS_EXPIRATION=15m
      # - JWT_REFRESH_EXPIRATION=7d
      # - MAX_SESSIONS_PER_USER=0
    depends_on:
      - playwright-debug
    develop:
      watch:
        - action: sync
          path: ./back/src
          target: /usr/src/app/src
          ignore:
            - node_modules/
        - action: rebuild
          path: ./back/package.json

    volumes:
      - ./back/.env:/usr/src/app/.env
      - api-data:/usr/src/app/data

  app:
    build:
      context: ./front
      dockerfile: Dockerfile.dev
    ports:
      - "${APP_PORT}:4200"
    develop:
      watch:
        - action: sync
          path: ./front/src
          target: /usr/src/app/src
          ignore:
            - node_modules/
        - action: rebuild
          path: ./front/package.json
    volumes:
      - ./front/public:/usr/src/app/public

  playwright-debug:
    image: browserless/chrome:latest
    ports:
      - "${PLAYWRIGHT_NOVNC_PORT}:3000"
      - "9222:9222"
    environment:
      - CONNECTION_TIMEOUT=600000
      - MAX_CONCURRENT_SESSIONS=10
      - ENABLE_DEBUGGER=true
      - PREBOOT_CHROME=true
      - KEEP_ALIVE=true
    networks:
      - gatuno-net

  database-master:
    ports:
      - "${DB_MASTER_EXTERNAL_PORT}:3306"

  database-slave-1:
    ports:
      - "${DB_SLAVE_1_EXTERNAL_PORT}:3306"

  database-slave-2:
    ports:
      - "${DB_SLAVE_2_EXTERNAL_PORT}:3306"
